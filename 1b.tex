\section{Анализ соответствия модели кластерообразования с использованием
весовых множителей дискретному уравнению Смолуховского.}

Чтобы показать соответствие случайного процесса дискретному уравнению Смолуховского рассмотрим функцию
\begin{equation}
\phi(m, t) = \sum_{i=1}^{N} w_i[l_i=m],
\label{first_conc_est}
\end{equation}
которая равна концентрации кластеров размера $l$ в момент времени $t$.


Рассмотрим эволюцию концентрации частиц $\phi(m,t)$ на шаге $\Delta t$. Увеличение концентрации будет происходить за  счет столкновений
частиц $p_i$ и $p_j$, размер которых удовлетворяет условию $l_i + l_j = m$, при этом концентрация увеличится на $\min(w_i, w_j)$.
Математическое ожидание прироста концентрации будет составлять 
\begin{align*}
I^+ (m ,& t+\Delta t) = \frac12 \sum_{i=1}^{N}\sum_{j=1}^N p_{ij} \min(w_i, w_j)[l_i+l_j = m][i \neq j]=\\
%&\frac12 \sum_{i = 1}^{N}\sum_{j=1}^{N} w_i w_j K(l_i, l_j) \Delta t [l_i + l_j = m]=
&\frac{\Delta t}{2} \sum_{i = 1}^{N} w_i K(l_i, l - l_i) \sum_{j=1}^{N} w_j[l_j = m - l_i][i \neq j]=\\
&\frac{\Delta t}{2} \sum_{i = 1}^{N} w_i K(l_i, m - l_i) (\phi(m - l_i, t)[l_i \neq \frac{m}{2}] + (\phi(l_i, t) - w_i) [l_i = \frac{m}{2}]) = \\
&\frac12 \sum_{x = 1}^{l-1} \phi(x, t) \phi (m-x,t) K(x, m-x) \Delta t - 
\frac12 \sum_{i = 1}^{N} w_i^2 K(l_i, l_i) \Delta t [l_i = \frac{m}{2}]
\end{align*}

Множитель $\frac12$ возникает, потому что суммирование осуществляется по всем парам частиц дважды. 
Во второй строчке используется следующий факт: $\max(w_i, w_j) \min (w_i, w_j) = w_i w_j$, а также независимость выбора частиц $i$ и $j$.
Полученное выражение показывает, что оценка \ref{first_conc_est} оказывается смещенной: множество частиц, которые представляет
модельная могут столкнуться между собой, а алгоритм моделирования не предполагает этого. Для получения точной оценки можно ввести дополнительный множитель
для столкновений частиц одного размера:
$$
p^*_{ij} = p_{ij}\,\frac{\phi^2(m,t)}{\phi^2(m,t) - \sum_{k=1}^{N}w_k^2[l_k = m]}[l_i = l_j = m]
$$

Тогда данная сумма будет совпадать с первым членом в уравнении Смолуховского. Такой подход оказывается неудобным, если при моделировании возникнет
ситуация, когда все кластеры размера $m$ представлены одной модельной частицей. Второе решение заключается в введении столкновений
модельных частиц с собой. С вероятностью $p_{ii} = K(l_i, l_i)w_i \Delta t$ произойдет столкновение: $(w_i, l_i) \rightarrow (\frac12 w_i, 2 l_i)$.
Тогда увеличение концентрации частиц размера $m$ из-за столкновений частиц с самими собой будет:
$$
I^{+*}(m, t+\Delta t) = \sum_{i = 1}^{N} \frac12 K(l_i, l_i) w_i^2 \Delta t,
$$
что соответствует остаточному члену $I^+(m, t+\Delta t)$ и оценка \ref{first_conc_est} с введением новых столкновений будет несмещенной.


Математическое ожидание уменьшения концентраций вычисляется аналогичным образом:
\begin{align*}
&I^- (l, t+dt) = \sum_{i=1}^{N}\sum_{j=1}^{N} w_i w_j K(l_i, l_j) dt [l_i = l][i \neq j] = \\
&\sum_{x=1}^{\max l} \sum_{i=1}^{N} w_i K(l, x) \phi(x, t) dt [l_i = l] [x \neq l] + \frac12 \sum_{i=1}^{N} 2 w_i w_j K(l, l) dt [l_i=l_j = l]\\
&\sum_{x=1}^{\max l} K(l, x) \phi(l, t) \phi(x, t) dt - \sum_{i=1}^{N} w_i^2 k(l, l) dt [l_i=l]
\end{align*}

Множитель $\frac12$ возникает из-за двойного обхода, а 2 - из-за, того, что вес уменьшается сразу у двух частиц.
Учитывая введение столкновений модельных частиц с самими собой получим второй член в уравнении Смолуховского. 

Таким образом, математическое ожидание величины $\phi(l, t)$ совпадает с разностной схемой, аппроксимирующей дискретное уравнение Смолуховского.
В работе \cite{GalkinBook2009} показано, что такая схема является устойчивой и сходится с первым порядком точности.


