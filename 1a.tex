\section{Алгоритм моделирования процесса коагуляции схемой испытаний 
Бернулли с использованием весовых множителей.}

В работах Королева-Яницкого было впервые предложено использовать схему 
испытаний Бернулли для моделирования химических реакций. Как показали 
численные эксперименты, расчеты можно проводить при небольшом числе 
частиц и избежать сильного влияния квадратичной зависимости. С другой 
стороны в задачах кластерообразования в результате взаимодействия частиц 
возникает множество сортов кластеров различающихся по массам и диаметрам 
и в расчетах приходится сталкиваться с проблемой квадратичной зависимости 
от количества реагирующих смесей. Для решения этой проблемы можно 
использовать не фиксированные сорта частиц, а переменные: наряду с 
индивидуальными характеристиками частицы, такими как скорость или вес, 
можно использовать и сорт, к которому она принадлежит. 
 
 
Рассмотрим эту схему для моделирования дискретного уравнения Смолуховского. Будем решать задачу Коши следующего вида:

\begin{equation}
\left\{ \begin{split}
	&\frac{\partial n(l, t)}{\partial t} = \frac{1}{2}\sum_{i=1}^{l-1}K(l-i, i) n(i, t) n(l-i,t) - \sum_{i=1}^{\infty} K(l, i) n(l, t) n(i, t) \\
	&n(l, 0) = \phi(l)
	\end{split}
\right.
\end{equation},

где $n(l, t)$ - концентрация кластеров, состоящих из $l$ частиц в момент времени $t$, а $K(x, y)$ - ядро коагуляции,
которое определяет скорость с которой частицы размером $x$ взаимодействуют с частицами размером $y$. Из физических
соображений полагают, что $K(x, y) = K(y, x)$.

Для удобства изложения введем следующие термины. 
Модельная частица $p$ - это пара чисел $(l, w)$, где $l \in \mathbb{N}$ - 
определяет размер кластеров, которые представляет модельная частица, а $w \in \mathbb{R}_{+}$ - определяет ее вес, 
т.е. количество кластеров, которые она представляет.\\
$l(p)$ - функция, возвращающая размер кластеров, которые представляет модельная частица $p$\\
$w(p)$ - функция, возвращающая вес $p$.

Концентрацией кластеров размером $l$ в системе из $N$ частиц будет функция $n(l) = \sum_{i=1}^{N}w(p_i) [ l(p_i) = l]$. 
$[x]$ - нотация Айверсона, равная 1, если выражение $x$ - истинно и 0, если ложно.

Реализация схемы Бернулли - множество ячеек из $M$ модельных частиц, проиндексированных параметром $t \in T$.

Столкновение двух частиц - функция, отображающая частицы $p_i$ и $p_j$ в себя следующим образом(для удобства $w(p_i) < w(p_j))$:
\begin{equation*}
\left(
\begin{split}
w(x), l(x)\\
w(y), l(y)
\end{split}\right)
\rightarrow
\left(
\begin{split}
& w(x),& l(x) + l(y)\\
& w(y) - w(x),& l(x)
\end{split}\right)
\end{equation*}


Суммарная масса частиц при этом не меняется:
$w(x) l(x) +  w(y) l(y) = w(x)(l(x) + l(y)) +  (w(y) - w(x)) l(x)$

Эволюцию модели на временном шаге $\Delta t$ будем рассчитывать по следующему алгоритму.
В системе из $N$ частиц для всех возможных пар частиц $(p_i, p_j)$ выполняются следующие процедуры:
\begin{description}
\item[Шаг 1.] Разыгрывается факт взаимодействия с вероятностью $$P = K(l(p_i), l(p_j)) \max (w(p_i), w(p_j)) \Delta t$$
\item[Шаг 2.] Если взаимодействие произошло, то частицы заменяются на новые, в соответствии с функцией столкновения. 
В противном случае параметры частиц не меняются.
\item[Шаг 3.] Перемешивание модельных частиц между реализациями случайного процесса.
\end{description}


Основная цель работы, сохранить постоянное число модельных частиц в каждой
реализации. В силу парности взаимодействия, и неравенстве весов нужно 
позаботиться о правильном определении новых сортов. 
%Вероятность взаимодействия модельных частиц пропорциональна максимальному весу пары частиц, потому что можно выделить
Шаг 3 алгоритма необходим в силу того, что в модели используется небольшое количество частиц и моделируемый процесс соответствует уравнению
Смолуховского только на одном шаге $\Delta t$. Если рассмотреть последующие шаги алгоритма, то математическое ожидание колебания
концентрации кластеров уже не будет совпадать с разностной аппроксимацией уравнения. Таким образом, на втором шаге алгоритма известна 
функция распределения кластеров по размерам, однако продолжение итераций независимых реализаций с теми же частицами будет приводить к 
систематической ошибке. Чтобы избежать ее, можно заново разыграть параметры модельных частиц в соответствии с функцией распределения 
на шаге $\Delta t$, т.е. перемешать модельные частицы между реализациями.

В качестве иллюстративного примера рассмотрим следующую марковскую цепь, состоящую из одной частицы(рис. \ref{fig_markov_1}), имеющую
один параметр - вес $w$. С вероятностью $p = K \Delta t$ вес частицы уменьшится в 2 раза на шаге $\Delta t$.
\begin{figure}[h]
 \centering
 \includegraphics[width=0.5\textwidth]{./fig/markov_example_1.png}
 % markov_example_1.png: 1440x961 pixel, 899dpi, 4.07x2.71 cm, bb=0 0 115 77
 \caption{Граф цепи маркова.}
 \label{fig_markov_1}
\end{figure}

Математическое ожидание веса частицы на шаге $\Delta t$ будет:
$$
\mathbb{E}[w(t+\Delta t)] = (1-p)w(t) + p\frac12 w(t) = w(t) - \frac12 p \, w(t)
$$
Что означает, что эта цепь соответствует раностному уравнению 
\begin{equation}
\frac{\Delta w(t)}{\Delta t} = -\frac12 K w(t)\label{diff_eq} 
\end{equation}

на уровне математического ожидания. Однако если рассмотреть математическое ожидание веса частицы на втором шаге(рис. \ref{fig_markov_2}),
то мы увидим, что марковская цепь перестает соответствовать разностному уравнению \ref{diff_eq}.
\begin{figure}[h]
 \centering
 \includegraphics[width=0.8\textwidth]{./fig/markov_example_2.png}
 % markov_example_2.png: 1000x685 pixel, 1794dpi, 1.42x0.97 cm, bb=0 0 40 27
 \caption{Возможные состояния марковской цепи на 2 шаге}
 \label{fig_markov_2}
\end{figure}
Математическое ожидание веса частицы на втором шаге:
\begin{align*}
\mathbb{E}&[w(t+2\Delta t)] = (1-p)^2 w(t) + 2p(1-p) \frac{w(t)}{2} + p^2 \frac{w(t)}{4} = \\
& = w(t) \left(1 - p - \frac{1}{4}p^2\right) = w(t) (1 - K\Delta t + \frac{1}{4}K^2\Delta t^2)
\end{align*}
В то время как разностное уравнение дает:
\begin{align*}
w&(t+2\Delta t) = w(t+\Delta t) - \frac12 \Delta t K w(t+\Delta t) = \\
&=w(t)(1 - \frac32 K \Delta t + \frac14K^2\Delta t^2)
\end{align*}

Таким образом, оценка весов в схемах с конечным числом частиц будет смещенной. Чтобы получать несмещенное решение можно
переводить моделируемую систему в новое состоние. Так как известно математическое ожидание распределения частиц по весам
на следующем шаге, то можно разыграть состояние системы в соответствии с новыми функциями распределения. Однако у нас
уже есть случайные величины с нужными функциями распределениями, а новое состояние будет всего лишь перестановкой этих
величин.